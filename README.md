# external-mysql-operator

**external-mysql-operator** exists to create / delete databases, manage users and handle initialization process on existing external mysql instances

it was written with kopf ( https://github.com/nolar/kopf )

operator itself does not require any configuration

it is configurable by two custom resources:

####  instance ( ` instances.mysql.getresponse.com` )
---
instance object must have following properties:
   * **address** - str - where operator should connect and create database 
   * **port** - int - instance port
   * **secretName** - str - name of secret which refers to root instance user

   along with instance object we have to create secret with user who is able to **create** databases and have **grant option** on instance

   eg.
   `CREATE USER 'superuser'@'%' IDENTIFIED BY 'testpassword';`
   `GRANT ALL PRIVILEGES ON *.* TO 'superuser'@'%' WITH GRANT OPTION;`

instance secret should have two k/vs:
   - **INSTANCE_USER**: base64
   - **INSTANCE_PASSWORD**: base64


instance objects and their secrets should be placed in operator's namespace

####  database ( ` databases.mysql.getresponse.com` )
---
   database object must have following properties:
   * **instance** - str - name of instance custom resource
   * **dropOnDelete** - boolean - tell operator if database should be deleted along with database custom resource
   * **users** - list of objects
      * **username** - str - username
      * **password** - str - password ( not required - if not set operator will generate random password and create secret with it in CR namespace )
      * **tables** - list of strings - tables to apply privileges, accepts '*'
      * **privileges** - list of strings - eg. SELECT, INSERT, UPDATE, ALL PRIVILEGES
   * **initDb** - object - if exists, operator runs job with image and script defined below
      * **initDbScript** - str - script used to initialize database ( bash, python etc )
      * **initDbImage** - str - image used to run above script on

operator will create database on desired instance with same name of defined database custom resource

#### example
---
to run locally install tilt ( https://docs.tilt.dev/install.html ) and just type `tilt up`,  press `s` to stream logs

it will deploy operator along with mysql instance placed in `external-mysql-operator` namespace, it also creates secret with root password for instance ( used both for mysql deployment and instance CR )

add instance custom resource by `kubectl apply -f example/example-instance.yaml`

add database custom resource by `kubectl apply -f example/example-database.yaml`

check if database exists:

`kubectl -n external-mysql-operator exec -it deployments/mysql -- mysql -umyuser -ptestpassword -e 'show databases'`
```
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mydb               |
| mysql              |
| performance_schema |
+--------------------+
```
check if database is initialized by your script:

`kubectl -n external-mysql-operator exec -it deployments/mysql -- mysql -umyuser -ptestpassword mydb -e 'show tables'`

```
+----------------+
| Tables_in_mydb |
+----------------+
| MyTable        |
+----------------+
```

show logs from database initialization job:

`kubectl logs jobs/initdb-mydb`
```
database initialized !
```

get autogenerated password for admin

`kubectl get secret mydb-admin -o go-template='{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\n"}}{{end}}'`
```
DB_HOST_MYDB: mydb
DB_PASSWORD_MYDB: 5FPK99JA3NSHK8JO
DB_USER_MYDB: admin
```

during initialization, operator creates initdb-(database-name) user with all permissions on database to make initialization possible

#### installation
---
`cd manifests`
`kubectl apply -k .`
```
namespace/external-mysql-operator configured
customresourcedefinition.apiextensions.k8s.io/databases.mysql.getresponse.com created
customresourcedefinition.apiextensions.k8s.io/instances.mysql.getresponse.com created
serviceaccount/external-mysql-operator-account created
clusterrole.rbac.authorization.k8s.io/external-mysql-operator-account created
clusterrolebinding.rbac.authorization.k8s.io/external-mysql-operator-account created
deployment.apps/external-mysql-operator created
```
